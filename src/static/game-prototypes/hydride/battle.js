function ControllerBase(){}function EnemyController(){this.roomsToInvestigate=[]}function Faction(a){var b=this;b.game=a,b.enemyFactions=[],b.actors=[],b.orders=[],b.orderGiven=new SprigganEventRecurring,b.game.factions.push(b)}function Animosity(a,b){var c=this;c.between=[a,b],a.enemyFactions.push(b),b.enemyFactions.push(a)}function Game(a){function b(){d.contentManager=ShowLoadingScreen(c),e.get(SprigganJavaScript,"battle/maps/"+a.map+".js")(d),d.tileset=Tilesets[d.tilesetName],d.tilesetSpriteSheet="battle/tilesets/"+d.tilesetName,d.contentManager.add(SprigganSpriteSheet,d.tilesetSpriteSheet),e.dispose()}function c(){d.viewport=new SprigganViewport(screenWidth,screenHeight),d.group=new SprigganGroup(d.viewport),d.group.move(screenWidth/2,(screenHeight-d.tileset.gridSpacing)/2),d.backgroundGroup=new SprigganGroup(d.group),d.backgroundOverlayGroup=new SprigganGroup(d.group),d.itemPickupsGroup=new SprigganGroup(d.group),d.markersGroup=new SprigganGroup(d.group),d.actorsGroup=new SprigganGroup(d.group),d.effectsGroup=new SprigganGroup(d.group),d.foregroundGroup=new SprigganGroup(d.group),d.contentLoaded.raise();for(var a=d.exteriorDoors[d.savegame.fromDoor],b=a.room.x*d.tileset.gridSpacing+DirectionOffsetX(a.position,d.tileset.gridSpacing/2),c=a.room.y*d.tileset.gridSpacing+DirectionOffsetY(a.position,d.tileset.gridSpacing/2),e=ReverseDirection(a.position),f=0;f<d.savegame.party.length;f++)(new HeroController).bindTo(new HumanActor(d.partyFaction,a.room,d.savegame.party[f],b,c,e));d.inventory=new Inventory(d),d.playPause=new PlayPause(d),d.enemyFaction.actors.length?d.setMode(new CombatMode):d.setMode(new ExploringMode)}var d=this;d.savegame=a,d.interactionMode="command",d.interactionModeChanged=new SprigganEventRecurring,d.contentLoaded=new SprigganEventOnce,d.exteriorDoors={},d.actors=[],d.factions=[],d.partyFaction=new Faction(d),d.enemyFaction=new Faction(d),new Animosity(d.partyFaction,d.enemyFaction);var e=ShowLoadingScreen(b);e.add(SprigganJavaScript,"battle/maps/"+a.map+".js")}function CombatMode(){}function FindingExitMode(a,b){this.exteriorDoor=a,this.modeWhenCancelled=b}function ExitingMode(a){this.exteriorDoor=a}function HeroSelectedMode(a){this.actor=a,this.sprite=new SprigganSprite(this.actor.group,BattleContent,"battle/markers"),this.sprite.loop("selected")}function ThrowingItemMode(a){this.inventorySlot=a,this.item=this.inventorySlot.item}function ExploringMode(){}function HeroController(){}function HumanActor(a,b,c,d,e,f){var g=this;g.faction=a,g.faction.actors.push(g),g.room=b,g.configuration=c,g.layers=[],g.destination=b,g.facing=f,g.health=g.healthLimit=6,g.initialX=d,g.initialY=e,a.orderGiven.listen(function(){g.think()})}function Inventory(a){function b(){c.opened=!c.opened,c.refresh()}var c=this;c.game=a,c.opened=!1,c.viewport=new SprigganViewport(screenWidth,screenHeight,"right","bottom"),c.icon=new SprigganSprite(c.viewport,BattleContent,"battle/inventory",b),c.icon.move(screenWidth,screenHeight),c.panelGroup=new SprigganGroup(c.viewport),c.panelGroup.move(screenWidth+120,screenHeight),c.panelBackground=new SprigganSprite(c.panelGroup,BattleContent,"battle/inventory"),c.panelBackground.loop("panel"),c.slots=[];for(var d=0;d<4;d++)for(var e=0;e<3;e++)new InventorySlot(c,e,d);c.refresh()}function InventorySlot(a,b,c){var d=this;d.inventory=a,d.x=b,d.y=c,d.reserved=!1,d.id=a.slots.length,a.slots.push(d),d.group=new SprigganGroup(a.panelGroup,function(){a.game.mode.clicked(d)}),d.group.move(39*b-98,39*c-178),d.itemSprite=new SprigganSprite(d.group,BattleContent,"battle/inventory"),d.statusSprite=new SprigganSprite(d.group,BattleContent,"battle/inventory"),d.refresh()}function ShouldAttackActor(a,b){return!!b.health&&!!a.faction.shouldAttack(b.faction)}function ItemPickup(a,b){var c=this;c.room=a,a.game.contentLoaded.listen(function(){function d(e){e.controller instanceof HeroController&&a.game.inventory.tryToAcquire(b)&&(c.sprite.dispose(),BattleContent.sounds.pickUpWrench.play(),a.entered.unlisten(d))}c.sprite=new SprigganSprite(a.game.itemPickupsGroup,BattleContent,"battle/itemPickups",function(){a.game.mode.clicked(c)}),a.entered.listen(d),c.sprite.loop("wrench"),c.sprite.move(a.x*a.game.tileset.gridSpacing,a.y*a.game.tileset.gridSpacing)})}function Capitalize(a){return a[0].toUpperCase()+a.slice(1)}function DirectionBetween(a,b,c,d){return Math.abs(a-c)>Math.abs(b-d)?c>a?"right":"left":d>b?"down":"up"}function DirectionOffsetX(a,b){switch(a){case"left":return-b;case"right":return b;default:return 0}}function DirectionOffsetY(a,b){switch(a){case"up":return-b;case"down":return b;default:return 0}}function ReverseDirection(a){switch(a){case"up":return"down";case"down":return"up";case"left":return"right";case"right":return"left";case null:return null}}function MakeSubclass(a,b){b.prototype=Object.create(a.prototype)}function RandomFromArray(a){return a[Math.floor(Math.random()*a.length)]}function Order(a,b,c,d,e,f,g,h){var i=this;i.faction=a,i.canExecute=f,i.execute=g,i.onCancel=h,i.faction.orders.push(i),i.markerSprite=new SprigganSprite(b,BattleContent,"battle/markers",function(){i.cancel()}),i.markerSprite.move(d,e),i.markerSprite.loop(c),i.faction.orderGiven.raise()}function PlayPause(a){function b(){c.paused=!c.paused,c.paused?(c.sprite.loop("play"),a.group.pause()):(c.sprite.loop("pause"),a.group.resume())}var c=this;c.viewport=new SprigganViewport(screenWidth,screenHeight,"left","bottom"),c.sprite=new SprigganSprite(c.viewport,BattleContent,"battle/battle",b),c.sprite.move(0,screenHeight),c.sprite.loop("pause"),c.paused=!1}function Room(a,b,c,d){var e=this;e.game=a,e.x=b,e.y=c,e.links={},e.entered=new SprigganEventRecurring,e.left=new SprigganEventRecurring,e.entered=new SprigganEventRecurring,e.actors=[],e.idleActors=[],a.contentLoaded.listen(function(){e.sprite=new SprigganSprite(a.backgroundGroup,a.contentManager,a.tilesetSpriteSheet,function(){e.game.mode.clicked(e)}),e.sprite.move(e.x*e.game.tileset.gridSpacing,e.y*e.game.tileset.gridSpacing),e.sprite.loop(d||"room")})}function MakeLink(a){a.prototype.roomOpposite=function(a){return a==this.fromRoom?this.toRoom:this.fromRoom},a.prototype.enteredBy=function(a){},a.prototype.leftBy=function(a){},a.prototype.blocksLineOfSight=function(a){return!1},a.prototype.blocksLineOfSightBelowWaist=function(a){return!1},a.prototype.linkToRooms=function(){return this.fromRoom.y!=this.toRoom.y?(this.orientation="vertical",this.fromRoom.y>this.toRoom.y?(this.direction="up",this.fromRoom.links.up=this,this.toRoom.links.down=this):(this.direction="down",this.fromRoom.links.down=this,this.toRoom.links.up=this),"Horizontal"):(this.orientation="horizontal",void(this.fromRoom.x>this.toRoom.x?(this.direction="left",this.fromRoom.links.left=this,this.toRoom.links.right=this):(this.direction="right",this.fromRoom.links.right=this,this.toRoom.links.left=this)))}}function InteriorDoor(a,b,c){var d=this;d.users=0,d.fromRoom=a,d.toRoom=b,d.linkToRooms(),d.animationPrefix=(c||"interiorDoor")+Capitalize(d.orientation),d.game=b.game,d.game.contentLoaded.listen(function(){d.sprite=new SprigganSprite(d.game.backgroundOverlayGroup,d.game.contentManager,d.game.tilesetSpriteSheet),d.sprite.move((a.x+b.x)*a.game.tileset.gridSpacing/2,(a.y+b.y)*a.game.tileset.gridSpacing/2),d.sprite.loop(d.animationPrefix+"Closed"),d.foregroundSprite=new SprigganSprite(d.game.foregroundGroup,d.game.contentManager,d.game.tilesetSpriteSheet),d.foregroundSprite.move((a.x+b.x)*a.game.tileset.gridSpacing/2,(a.y+b.y)*a.game.tileset.gridSpacing/2),d.foregroundSprite.loop(d.animationPrefix+"Foreground")})}function Path(a,b,c){var d=this;d.fromRoom=a,d.toRoom=b,d.linkToRooms(),d.game=b.game,d.game.contentLoaded.listen(function(){d.sprite=new SprigganSprite(d.game.backgroundOverlayGroup,d.game.contentManager,d.game.tilesetSpriteSheet),d.sprite.move((a.x+b.x)*a.game.tileset.gridSpacing/2,(a.y+b.y)*a.game.tileset.gridSpacing/2),d.sprite.loop((c||"path")+Capitalize(d.orientation))})}function Ledge(a,b,c){var d=this;d.fromRoom=a,d.toRoom=b,d.linkToRooms(),d.game=b.game,d.game.contentLoaded.listen(function(){d.sprite=new SprigganSprite(d.game.backgroundOverlayGroup,d.game.contentManager,d.game.tilesetSpriteSheet),d.sprite.move((a.x+b.x)*a.game.tileset.gridSpacing/2,(a.y+b.y)*a.game.tileset.gridSpacing/2),d.sprite.loop((c||"ledge")+Capitalize(d.direction))})}function Decoration(a,b,c){var d=this;d.room=a,d.game=a.game,d.game.contentLoaded.listen(function(){d.sprite=new SprigganSprite(d.game.backgroundOverlayGroup,d.game.contentManager,d.game.tilesetSpriteSheet),d.sprite.move(a.x*a.game.tileset.gridSpacing,a.y*a.game.tileset.gridSpacing),d.sprite.loop(c+b[0].toUpperCase()+b.slice(1))})}function ExteriorDoor(a,b,c,d){var e=this;e.room=a,e.position=b,e.game=a.game,e.map=d||null,e.game.exteriorDoors[e.map]=e,e.spritePrefix=(c||"exteriorDoor")+Capitalize(b),e.game.contentLoaded.listen(function(){function c(){e.game.mode.clicked(e)}e.markerX=a.x*e.game.tileset.gridSpacing+DirectionOffsetX(b,40),e.markerY=a.y*e.game.tileset.gridSpacing+DirectionOffsetY(b,40),e.sprite=new SprigganSprite(e.game.backgroundOverlayGroup,e.game.contentManager,e.game.tilesetSpriteSheet,c),e.sprite.move(a.x*a.game.tileset.gridSpacing,a.y*a.game.tileset.gridSpacing),e.map==e.game.savegame.fromDoor?(BattleContent.sounds.closeDoor.play(),e.sprite.play(e.spritePrefix+"Open",function(){e.sprite.play(e.spritePrefix+"Closing",function(){e.sprite.loop(e.spritePrefix+"Closed")})})):e.sprite.loop(e.spritePrefix+"Closed"),e.foregroundSprite=new SprigganSprite(e.game.foregroundGroup,e.game.contentManager,e.game.tilesetSpriteSheet,c),e.foregroundSprite.move(a.x*a.game.tileset.gridSpacing,a.y*a.game.tileset.gridSpacing),e.foregroundSprite.loop(e.spritePrefix+"Foreground")})}function EnemySpawnPoint(a){var b=this;b.room=a,b.game=a.game,b.game.contentLoaded.listen(function(){(new EnemyController).bindTo(new HumanActor(b.game.enemyFaction,b.room,{legs:"brownTrousers",torso:"leatherJacket",weapon:"pistol",hair:"orangeHair"},b.room.x*b.game.tileset.gridSpacing,b.room.y*b.game.tileset.gridSpacing,"down"))})}function SpriteGroup(a,b,c,d){for(this.sprites=[],this.prefixes=d;this.sprites.length<this.prefixes.length;)this.sprites.push(new SprigganSprite(a,b,c))}ControllerBase.prototype.bindTo=function(a){this.actor=a,a.controller=this,this.game=a.room.game,a.setup(),this.setup()},ControllerBase.prototype.hearSound=function(a){},ControllerBase.prototype.seeMotion=function(a,b,c){},MakeSubclass(ControllerBase,EnemyController),EnemyController.prototype.setup=function(){},EnemyController.prototype.getDirectionToMove=function(){for(var a=this,b=0;b<a.game.factions.length;b++){var c=a.game.factions[b];if(a.actor.faction.shouldAttack(c))for(var d=0;d<c.actors.length;d++){var e=c.actors[d];if(a.actor.canAttack(e.room))return null}}if(a.roomsToInvestigate.length)return SprigganRemoveByValue(a.roomsToInvestigate,a.actor.room),a.actor.room.navigateTo(function(b){return a.roomsToInvestigate.indexOf(b)!=-1})},EnemyController.prototype.recordRoomToInvestigate=function(a){return this.roomsToInvestigate.indexOf(a)==-1&&(this.roomsToInvestigate.push(a),this.actor.think(),!0)},EnemyController.prototype.hearSound=function(a){this.recordRoomToInvestigate(a)},EnemyController.prototype.seeMotion=function(a,b,c){this.actor.faction.shouldAttack(a.faction)&&this.recordRoomToInvestigate(c)},Faction.prototype.shouldAttack=function(a){return this.enemyFactions.indexOf(a)!=-1},Faction.prototype.think=function(){for(var a=0;a<this.actors.length;a++)this.actors[a].think()},Game.prototype.dispose=function(){this.contentManager.dispose(),this.viewport.dispose(),this.inventory.dispose(),this.playPause.dispose()},Game.prototype.setMode=function(a){this.mode&&this.mode.left(),this.mode=a,this.mode.showInventory?this.inventory.viewport.show():this.inventory.viewport.hide(),a.game=this,this.mode.entered()},CombatMode.prototype.clicked=function(a){if(a.controller instanceof HeroController&&this.game.setMode(new HeroSelectedMode(a)),a instanceof InventorySlot){if(a.reservedFor)return;if(!a.item)return;a.item["throw"]&&this.game.setMode(new ThrowingItemMode(a))}a instanceof ExteriorDoor&&this.game.setMode(new FindingExitMode(a,CombatMode))},CombatMode.prototype.entered=function(){},CombatMode.prototype.showInventory=!0,CombatMode.prototype.left=function(){},FindingExitMode.prototype.entered=function(){var a=this;a.sprite=new SprigganSprite(a.game.markersGroup,BattleContent,"battle/markers",function(){a.clicked(a.exteriorDoor)}),a.sprite.move(a.exteriorDoor.markerX,a.exteriorDoor.markerY),a.sprite.loop("exiting"),a.game.partyFaction.think(),a.enteredCallback=function(){for(var b=0;b<a.game.partyFaction.actors.length;b++){var c=a.game.partyFaction.actors[b];if(!c.health)return;if(c.room!=a.exteriorDoor.room)return}a.game.setMode(new ExitingMode(a.exteriorDoor))},a.exteriorDoor.room.entered.listen(a.enteredCallback),a.enteredCallback()},FindingExitMode.prototype.showInventory=!1,FindingExitMode.prototype.clicked=function(a){a instanceof ExteriorDoor&&a!=this.exteriorDoor?this.game.setMode(new FindingExitMode(a,this.modeWhenCancelled)):(this.game.setMode(new this.modeWhenCancelled),this.game.mode.clicked(a))},FindingExitMode.prototype.left=function(){this.exteriorDoor.room.entered.unlisten(this.enteredCallback),this.sprite.dispose()},ExitingMode.prototype.entered=function(){var a=this;a.exteriorDoor.room.left.listen(function(b){for(var c=0;c<a.exteriorDoor.room.actors.length;c++){var d=a.exteriorDoor.room.actors[c];if(d.health&&d.faction==a.exteriorDoor.room.game.partyFaction&&d.room==a.exteriorDoor.room)return}a.game.viewport.dispose(),a.game.savegame.fromDoor=a.game.savegame.map,a.game.savegame.map=a.exteriorDoor.map,new Game(a.game.savegame)}),a.game.partyFaction.think(),a.exteriorDoor.open()},ExitingMode.prototype.showInventory=!1,ExitingMode.prototype.clicked=function(a){a instanceof ExteriorDoor&&a!=this.exteriorDoor?this.game.setMode(new ExitingMode(a)):this.game.setMode(new CombatMode)},ExitingMode.prototype.left=function(){this.exteriorDoor.room.entered.unlisten(this.enteredCallback),this.sprite.dispose()},HeroSelectedMode.prototype.entered=function(){},HeroSelectedMode.prototype.clicked=function(a){if(a==this.actor)this.game.setMode(new CombatMode);else if(a.controller instanceof HeroController)this.game.setMode(new HeroSelectedMode(a));else if(a instanceof ExteriorDoor)this.game.setMode(new FindingExitMode(a));else{var b;if(a instanceof Room&&(b=a),a instanceof EnemyController&&(b=a.actor.room),a instanceof ItemPickup&&(b=a.room),!b)return;this.actor.controller.destination=b,this.actor.think(),this.game.setMode(new CombatMode)}},HeroSelectedMode.prototype.left=function(){this.sprite.dispose()},HeroSelectedMode.prototype.showInventory=!0,ThrowingItemMode.prototype.entered=function(){},ThrowingItemMode.prototype.clicked=function(a){function b(a){return a.room.hasLineOfSightToRoom(e)}function c(a,b){f.inventorySlot.replace(null),a.torsoSpriteGroup.play("throw"+Capitalize(a.room.getDirectionToRoom(e)||"down"),function(){f.item["throw"](a,e),b()})}function d(){f.inventorySlot.reserveFor(null)}var e,f=this;a instanceof Room&&(e=a),a instanceof EnemyController&&(e=a.actor.room),a instanceof HeroController&&(e=a.actor.room),a instanceof ItemPickup&&(e=a.room),e&&(f.inventorySlot.reserveFor("throwing"),new Order(f.game.partyFaction,f.game.markersGroup,"throwing",e.x*f.game.tileset.gridSpacing,e.y*f.game.tileset.gridSpacing,b,c,d),f.game.setMode(new CombatMode))},ThrowingItemMode.prototype.left=function(){},ExploringMode.prototype.entered=function(){},ExploringMode.prototype.clicked=function(a){if(a instanceof ExteriorDoor)return void this.game.setMode(new FindingExitMode(a,ExploringMode));var b=null;if(a instanceof Room&&(b=a),b=b||a.room)for(var c=0;c<this.game.partyFaction.actors.length;c++)this.game.partyFaction.actors[c].controller.destination=b,this.game.partyFaction.actors[c].think()},ExploringMode.prototype.left=function(){},MakeSubclass(ControllerBase,HeroController),HeroController.prototype.setup=function(){},HeroController.prototype.getDirectionToMove=function(){var a=this;if(a.game.mode instanceof ExitingMode)return a.game.mode.exteriorDoor.position;var b;return b=a.game.mode instanceof FindingExitMode?a.game.mode.exteriorDoor.room:a.destination,a.actor.room.navigateTo(function(a){return a==b})},HumanActor.prototype.setup=function(){var a=this;a.room.game.contentLoaded.listen(function(){a.group=new SprigganGroup(a.room.game.actorsGroup,function(){a.room.game.mode.clicked(a)});var b=2;for(a.healthSprites=[];a.healthSprites.length<a.healthLimit;){var c=new SprigganSprite(a.group,BattleContent,"battle/markers");c.hide(),c.loop("healthGood"),c.move(b*(a.healthSprites.length+.5-a.healthLimit/2),0),a.healthSprites.push(c)}a.legSpriteGroup=new SpriteGroup(a.group,BattleContent,"battle/character",[a.configuration.legs]),a.legSpriteGroup.loop("idleDown"),a.torsoSpriteGroup=new SpriteGroup(a.group,BattleContent,"battle/character",[a.configuration.torso,a.configuration.weapon,a.configuration.hair]),a.torsoSpriteGroup.loop("idleDown"),a.group.move(a.initialX,a.initialY),a.room.game.actors.push(a),a.room.actors.push(a),a.room.addIdleActor(a,"up"),a.room.entered.raise(a)})},HumanActor.prototype.hurt=function(a){if(this.health){var b=Math.max(0,this.health-a);if(this.health==this.healthLimit)for(var c=0;c<this.healthLimit;c++)this.healthSprites[c].show();for(var c=b;c<this.health;c++)this.healthSprites[c].loop("healthBad");if(this.health=b,this.think(),!this.health){for(var c=0;c<this.healthLimit;c++)this.healthSprites[c].dispose();this.legSpriteGroup.play("death"),this.torsoSpriteGroup.play("death")}}},HumanActor.prototype.setDestination=function(a){var b=this;b.destination=a,b.think()},HumanActor.prototype.think=function(){function a(){f="left"==f?"right":"left",BattleContent.sounds.footstep.play(),b.legSpriteGroup.play("walk"+("left"==f?"A":"B")+Capitalize(b.facing),a)}var b=this;if(b.health){if(!b.moving){var c=b.controller.getDirectionToMove();if(c){b.room.removeIdleActor(b),b.facing=c;var d=b.room.links[c],e=null;if(d&&(e=d.roomOpposite(b.room)),b.moving=!0,!b.walking){b.walking=!0;var f="left";a()}var g=b.room.x*b.room.game.tileset.gridSpacing+DirectionOffsetX(b.facing,b.room.game.tileset.gridSpacing/2),h=b.room.y*b.room.game.tileset.gridSpacing+DirectionOffsetY(b.facing,b.room.game.tileset.gridSpacing/2),i=DirectionOffsetX(b.facing,b.room.game.tileset.linkLength),j=DirectionOffsetY(b.facing,b.room.game.tileset.linkLength);b.group.moveAtPixelsPerSecond(g-i,h-j,100,function(){d&&d.enteredBy(b),b.group.moveAtPixelsPerSecond(g,h,100,function(){SprigganRemoveByValue(b.room.actors,b),e&&e.actors.push(b);var a=b.room;b.room=e,a.left.raise(b),e&&e.entered.raise(b),e&&a.emitMotion(b,e),d&&b.group.moveAtPixelsPerSecond(g+i,h+j,100,function(){d.leftBy(b),b.moving=!1,b.room.addIdleActor(b,c)})})})}else b.destination=b.room,b.moving=!1}if(!b.moving){b.walking=!1;var g=b.room.x*b.room.game.tileset.gridSpacing,h=b.room.y*b.room.game.tileset.gridSpacing;if(b.room.idleActors.length>1){var k=2*b.room.idleActors.indexOf(b)*Math.PI/b.room.idleActors.length;g+=8*Math.sin(k),h+=8*Math.cos(k)}b.group.moveAtPixelsPerSecond(g,h,100),b.legSpriteGroup.loop("idle"+Capitalize(b.facing))}if(!b.acting)for(var l=0;l<b.faction.orders.length;l++)if(b.faction.orders[l].tryExecute(b,function(){b.acting=!1,b.think()})){b.acting=!0;break}Items[b.configuration.weapon].weapon.handle(b),b.acting||(b.moving?b.torsoSpriteGroup.loop("walk"+Capitalize(b.facing)):b.torsoSpriteGroup.loop("idle"+Capitalize(b.facing)))}},HumanActor.prototype.say=function(a,b,c){this.stopSaying(),this.speechGroup=SprigganWrite(this.group,sharedContent,"fontBig",fontBig,a,"center","bottom"),this.speechGroup.moveAtPixelsPerSecond(0,-12,64)},HumanActor.prototype.stopSaying=function(){this.speechGroup&&(this.speechGroup.dispose(),this.speechGroup=null)},HumanActor.prototype.hearSound=function(a){this.controller.hearSound(a)},HumanActor.prototype.seeMotion=function(a,b,c){this.controller.seeMotion(a,b,c)},HumanActor.prototype.canAttack=function(a){return Items[this.configuration.weapon].weapon.canAttack(this.room,a,!1)},Inventory.prototype.close=function(){this.opened=!1,this.refresh()},Inventory.prototype.refresh=function(){this.icon.loop(this.opened?"iconOpen":"iconClosed"),this.panelGroup.moveAtPixelsPerSecond(screenWidth+(this.opened?0:120),screenHeight,1e3)},Inventory.prototype.tryToAcquire=function(a){for(var b=this,c=0;c<b.game.savegame.inventory.length;c++)if(!b.game.savegame.inventory[c])return b.game.savegame.inventory[c]=a,b.slots[c].refresh(),b.icon.play("iconAdded",function(){b.refresh()}),!0;return b.icon.play("iconFull",function(){b.refresh()}),!1},Inventory.prototype.remove=function(a){this.game.savegame.inventory[a]=null,this.slots[a].refresh()},Inventory.prototype.dispose=function(){this.viewport.dispose()},InventorySlot.prototype.refresh=function(){this.itemName=this.inventory.game.savegame.inventory[this.id],this.itemName?(this.item=Items[this.itemName],this.itemSprite.loop(this.itemName),this.itemSprite.show(),this.statusSprite.loop("slot"+(this.reservedFor?Capitalize(this.reservedFor):"Occupied"))):(this.item=null,this.itemSprite.hide(),this.statusSprite.loop("slotEmpty"))},InventorySlot.prototype.replace=function(a){this.inventory.game.savegame.inventory[this.id]=a,this.reserveFor(null)},InventorySlot.prototype.reserveFor=function(a){this.reservedFor=a,this.refresh()};var Items={sword:{weapon:{damage:4,canAttack:function(a,b,c){return a==b},handle:function(a){function b(){for(var b=0;b<a.room.idleActors.length;b++)if(ShouldAttackActor(a,a.room.idleActors[b]))return a.room.idleActors[b];for(var b=0;b<a.room.actors.length;b++)if(ShouldAttackActor(a,a.room.actors[b]))return a.room.actors[b];return null}if(!a.acting){var c=b();c&&(a.acting=!0,a.facing=DirectionBetween(a.group.x(),a.group.y(),c.group.x(),c.group.y()),a.torsoSpriteGroup.play("drawSword"+Capitalize(a.facing),function(){function c(){var e=b();e?(e.hurt(3),a.facing=DirectionBetween(a.group.x(),a.group.y(),e.group.x(),e.group.y()),a.torsoSpriteGroup.play("swipeSword"+(d?"B":"A")+Capitalize(a.facing),c),d=!d):a.torsoSpriteGroup.play("stowSword"+Capitalize(a.facing),function(){a.acting=!1,a.think()})}var d=!1;c()}))}}}},pistol:{weapon:{damage:1,canAttack:function(a,b,c){return a.hasLineOfSightToRoom(b,c)},handle:function(a){function b(){var b=[];return a.room.emitLineOfSight(1e3,!0,function(c){for(var d=0;d<c.actors.length;d++)ShouldAttackActor(a,c.actors[d])&&b.push(c.actors[d])}),b[0]}if(!a.acting){var c=b();c&&(a.acting=!0,a.facing=DirectionBetween(a.group.x(),a.group.y(),c.group.x(),c.group.y()),BattleContent.sounds.pistolDraw.play(),a.torsoSpriteGroup.play("drawPistol"+Capitalize(a.facing),function(){function c(){var d=b();if(d){a.facing=DirectionBetween(a.group.x(),a.group.y(),d.group.x(),d.group.y()),a.torsoSpriteGroup.play("firePistol"+Capitalize(a.facing),c),BattleContent.sounds.pistolFire.play();var e=new SprigganSprite(a.room.game.effectsGroup,BattleContent,"battle/effects");e.loop("pistolTracer"+Capitalize(a.facing));var f=a.group.x(),g=a.group.y();switch(a.facing){case"down":g+=10;break;case"up":g-=10;break;case"right":f+=10;break;case"left":f-=10}switch(e.move(f,g),f=d.group.x(),g=d.group.y(),a.facing){case"down":g-=5;break;case"up":g+=5;break;case"right":f-=5;break;case"left":f+=5}e.moveAtPixelsPerSecond(f,g,600,function(){d.hurt(1),e.play("pistolImpact"+Capitalize(a.facing),function(){e.dispose()})})}else BattleContent.sounds.pistolStow.play(),a.torsoSpriteGroup.play("stowPistol"+Capitalize(a.facing),function(){a.acting=!1,a.think()})}c()}))}}}},wrench:{"throw":function(a,b){var c=new SprigganSprite(a.room.game.effectsGroup,BattleContent,"battle/itemPickups");c.move(a.group.x(),a.group.y()),c.loop("wrenchThrown"),BattleContent.sounds.throwWrench.play(),c.moveAtPixelsPerSecond(b.x*b.game.tileset.gridSpacing,b.y*b.game.tileset.gridSpacing,250,function(){b.emitSound(20),BattleContent.sounds.hitWrench.play(),c.dispose(),new ItemPickup(b,"wrench")})}}};Order.prototype.tryExecute=function(a,b){return!!this.canExecute(a)&&(SprigganRemoveByValue(this.faction.orders,this),this.markerSprite.dispose(),this.execute(a,b),!0)},Order.prototype.cancel=function(){SprigganRemoveByValue(this.faction.orders,this),this.markerSprite.dispose(),this.onCancel()},PlayPause.prototype.dispose=function(){this.viewport.dispose()},Room.prototype.addIdleActor=function(a,b){if(this.idleActors.indexOf(a)==-1){if(this.idleActors.length)if(1==this.idleActors.length)switch(b){case"up":this.idleActors.unshift(a);break;case"down":this.idleActors.push(a);break;default:Math.random()>=.5?this.idleActors.push(a):this.idleActors.unshift(a)}else switch(b){case"left":this.idleActors.splice(Math.ceil(this.idleActors.length/4),0,a);break;case"right":this.idleActors.splice(Math.ceil(3*this.idleActors.length/4),0,a);break;case"up":this.idleActors.unshift(a);break;case"down":this.idleActors.splice(Math.ceil(this.idleActors.length/2),0,a)}else this.idleActors.push(a);for(var c=0;c<this.idleActors.length;c++)this.idleActors[c].think()}},Room.prototype.removeIdleActor=function(a){if(this.idleActors.indexOf(a)!=-1){SprigganRemoveByValue(this.idleActors,a);for(var b=0;b<this.idleActors.length;b++)this.idleActors[b].think()}},Room.prototype.navigateTo=function(a){function b(c,d,e){if(!d.walkable(c))return 1/0;var g=d.roomOpposite(c);if(a(g))return e;var h,i;for(i=0;i<f.length;i++)if(h=f[i],h.room==g){if(h.distance<=e)return 1/0;h.distance=e;break}i==f.length&&(h={room:g,distance:e},f.push(h));var j=1/0;for(var k in g.links){var l=b(g,g.links[k],e+1);l<j&&(j=l)}return j}if(a(this))return null;var c=1/0,d=null;for(var e in this.links){var f=[{room:this,distance:0}],g=b(this,this.links[e],1);g>=c||(c=g,d=e)}return d},Room.prototype.emitLineOfSight=function(a,b,c){var d=this;c(d);for(var e in d.links)for(var f=d,g=d.links[e],h=0;g&&!(h++>a)&&!g.blocksLineOfSight(f)&&(!b||!g.blocksLineOfSightBelowWaist(f));){var i=g.roomOpposite(f);c(i),g=i.links[e],f=i}},Room.prototype.getDirectionToRoom=function(a){if(this.x==a.x){if(this.y>a.y)return"up";if(this.y<a.y)return"down"}else if(this.y==a.y)return this.x>a.x?"left":"right";return null},Room.prototype.hasLineOfSightToRoom=function(a,b){if(this==a)return!0;var c=this.getDirectionToRoom(a);if(!c)return!1;for(var d=this;d!=a;){var e=d.links[c];if(!e)return!1;if(e.blocksLineOfSight(d))return!1;if(b&&e.blocksLineOfSightBelowWaist(d))return!1;d=e.roomOpposite(d)}return!0},Room.prototype.floodfill=function(a,b,c){function d(f,g){if(!(g>=c)&&e.indexOf(f)==-1){b(f),e.push(f);for(var h in f.links)a(f.links[h],f)&&d(f.links[h].roomOpposite(f),g+1)}}var e=[];d(this,0)},Room.prototype.emitSound=function(a){var b=this;this.floodfill(function(a,b){return!a.blocksLineOfSight(b)},function(a){for(var c=0;c<a.actors.length;c++)a.actors[c].hearSound(b)},a)},Room.prototype.emitMotion=function(a,b){var c=this;b=b||c,c.emitLineOfSight(1e3,!1,function(d){for(var e=0;e<d.actors.length;e++)d.actors[e].seeMotion(a,c,b)}),b.emitLineOfSight(1e3,!1,function(d){for(var e=0;e<d.actors.length;e++)d.actors[e].seeMotion(a,c,b)})},MakeLink(InteriorDoor),InteriorDoor.prototype.enteredBy=function(a){var b=this;b.users||(BattleContent.sounds.openDoor.play(),b.sprite.play(b.animationPrefix+"Opening",function(){b.sprite.loop(b.animationPrefix+"Opened")})),b.users++},InteriorDoor.prototype.leftBy=function(a){var b=this;b.users--,b.users||(BattleContent.sounds.closeDoor.play(),b.sprite.play(b.animationPrefix+"Closing",function(){b.sprite.loop(b.animationPrefix+"Closed")}))},InteriorDoor.prototype.walkable=function(a){return!0},InteriorDoor.prototype.blocksLineOfSight=function(a){return!this.users},MakeLink(Path),Path.prototype.walkable=function(a){return!0},MakeLink(Ledge),Ledge.prototype.walkable=function(a){return a==this.fromRoom},ExteriorDoor.prototype.open=function(a){var b=this;BattleContent.sounds.openDoor.play(),b.sprite.play(b.spritePrefix+"Opening",a)},SpriteGroup.prototype.play=function(a,b){a=Capitalize(a);for(var c=0;c<this.sprites.length;c++)this.sprites[c].play(this.prefixes[c]+a,0==c?b:null)},SpriteGroup.prototype.loop=function(a){a=Capitalize(a);for(var b=0;b<this.sprites.length;b++)this.sprites[b].loop(this.prefixes[b]+a)};var Tilesets={leviathan:{gridSpacing:50,linkLength:10}};return{Game:Game,Room:Room,Path:Path,InteriorDoor:InteriorDoor,ExteriorDoor:ExteriorDoor,Ledge:Ledge,ItemPickup:ItemPickup,Decoration:Decoration,EnemySpawnPoint:EnemySpawnPoint};